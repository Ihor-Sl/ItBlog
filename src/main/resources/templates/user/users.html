<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="#{templates.users.html.title}">Users</title>
    <link rel="stylesheet" th:href="@{/static/css/header.css}">
    <link rel="stylesheet" th:href="@{/static/css/base.css}">
</head>
<body>
<header th:replace="~{fragments/header :: header}"></header>

<h1 th:text="#{templates.users.user-search}">User Search</h1>

<form th:action="@{/users}" method="get" th:object="${userSearchRequest}" class="search-form">
    <div class="form-group">
        <div class="error"
             th:if="${#fields.hasErrors('username')}"
             th:errors="*{username}">username error</div>
        <label for="username" th:text="#{common.user.field.username}">Username</label>
        <input type="text" id="username" name="username"
               th:value="*{username}"/>
    </div>

    <div class="form-group">
        <label for="fromAge" th:text="#{templates.users.age-range}">Age Range</label>
        <div class="age-range">
            <div class="error"
                 th:if="${#fields.hasErrors('fromAge')}"
                 th:errors="*{fromAge}">fromAge error</div>
            <div class="error"
                 th:if="${#fields.hasErrors('toAge')}"
                 th:errors="*{toAge}">toAge error</div>
            <input type="number" id="fromAge" name="fromAge"
                   th:value="*{fromAge}"
                   th:placeholder="#{templates.users.age-range.from}" min="0"/>
            <span class="range-separator" th:text="#{templates.users.to}">to</span>
            <input type="number" id="toAge" name="toAge"
                   th:value="*{toAge}"
                   th:placeholder="#{templates.users.age-range.to}" min="0"/>
        </div>
    </div>

    <div class="form-group">
        <label th:text="#{templates.users.locations}">Locations</label>
        <div id="locations-container">
            <template id="location-template">
                <div class="dynamic-input-group">
                    <input type="text" name="locations"
                           class="dynamic-input"/>
                    <button type="button" class="btn-remove" onclick="removeInput(this)">×</button>
                </div>
            </template>

            <div th:each="loc, iterStat : ${userSearchRequest.locations}">
                <div class="dynamic-input-group">
                    <input type="text" th:name="locations"
                           th:value="${loc}"
                           class="dynamic-input"/>
                    <button type="button" onclick="removeInput(this)">×</button>
                    <div class="error"
                         th:if="${#fields.hasErrors('locations[' + iterStat.index + ']')}"
                         th:errors="*{technologyStack[__${iterStat.index}__]}"></div>

                </div>
            </div>
        </div>
        <button type="button" class="btn-add" onclick="addInput('locations-container', 'location-template')" th:text="#{templates.users.add-location}">
            + Add Location
        </button>
    </div>

    <div class="form-group">
        <label th:text="#{common.user.technology-stack}">Technology Stack</label>
        <div id="tech-container">
            <template id="tech-template">
                <div class="dynamic-input-group">
                    <input type="text" name="technologyStack"
                           class="dynamic-input"/>
                    <button type="button" class="btn-remove" onclick="removeInput(this)">×</button>
                </div>
            </template>

            <div th:each="tech, iterStat : ${userSearchRequest.technologyStack}">
                <div class="dynamic-input-group">
                    <input type="text" th:name="technologyStack"
                           th:value="${tech}"
                           class="dynamic-input"/>
                    <button type="button" onclick="removeInput(this)">×</button>
                    <div class="error"
                         th:if="${#fields.hasErrors('technologyStack[' + iterStat.index + ']')}"
                         th:errors="*{technologyStack[__${iterStat.index}__]}"></div>
                </div>
            </div>
        </div>
        <button type="button" class="btn-add" onclick="addInput('tech-container', 'tech-template')" th:text="#{templates.users.add-technology}">
            + Add Technology
        </button>
    </div>

    <div class="form-actions">
        <button type="submit" class="btn btn-primary" th:text="#{templates.users.search}">Search</button>
        <a th:href="@{/users}" th:text="#{templates.users.clear}">Clear</a>
    </div>
</form>
<h2 th:text="#{templates.users.user-list}">User List</h2>

<table border="1">
    <thead>
    <tr>
        <th>Avatar</th>
        <th>Username</th>
        <th>Location</th>
        <th>Technology Stack</th>
        <th>Date of Birth</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="user : ${usersPage.content}">
        <td><img width="50px" height="50px" th:src="${user.avatarUrl}" alt="avatar"></td>
        <td><a th:text="${user.username}" th:href="@{/users/{id}(id=${user.id})}">Username</a></td>
        <td th:text="${user.location}">Location</td>
        <td th:text="${user.technologyStack != null ? #strings.arrayJoin(user.technologyStack, ', ') : ''}">Tech Stack</td>
        <td th:text="${user.dateOfBirth}">Date of Birth</td>
    </tr>
    </tbody>
</table>

<div>
    <ul>
        <li>
            <a th:href="@{${'/users'}(
                page=${0},
                size=${usersPage.getSize()},
                username=${userSearchRequest.username},
                fromAge=${userSearchRequest.fromAge},
                toAge=${userSearchRequest.toAge},
                locations=${userSearchRequest.locations},
                technologyStack=${userSearchRequest.technologyStack}
                )}"
                th:text="#{templates.common.pagination.first}"
            >First</a>
        </li>

        <li>
            <a th:class="${usersPage.isFirst() ? 'disabled' : ''}"
               th:href="@{${'/users'}(
               page=${usersPage.getNumber() - 1},
               size=${usersPage.getSize()},
               username=${userSearchRequest.username},
               fromAge=${userSearchRequest.fromAge},
               toAge=${userSearchRequest.toAge},
               locations=${userSearchRequest.locations},
               technologyStack=${userSearchRequest.technologyStack}
               )}"
               th:text="#{templates.common.pagination.previous}"
            >Previous</a>
        </li>

        <li>
            <a th:class="${usersPage.getNumber() - 2 >= 0 ? '' : 'disabled'}"
               th:href="@{${'/users'}(
               page=${usersPage.getNumber() - 2},
               size=${usersPage.getSize()},
               username=${userSearchRequest.username},
               fromAge=${userSearchRequest.fromAge},
               toAge=${userSearchRequest.toAge},
               locations=${userSearchRequest.locations},
               technologyStack=${userSearchRequest.technologyStack}
               )}"
               th:text="${usersPage.getNumber() - 2 >= 0 ? usersPage.getNumber() - 1 : '.'}"
            >Current - 2</a>
        </li>

        <li>
            <a th:class="${usersPage.getNumber() - 1 >= 0 ? '' : 'disabled'}"
               th:href="@{${'/users'}(
               page=${usersPage.getNumber() - 1},
               size=${usersPage.getSize()},
               username=${userSearchRequest.username},
               fromAge=${userSearchRequest.fromAge},
               toAge=${userSearchRequest.toAge},
               locations=${userSearchRequest.locations},
               technologyStack=${userSearchRequest.technologyStack}
               )}"
               th:text="${usersPage.getNumber() - 1 >= 0 ? usersPage.getNumber() : '.'}"
            >Current - 1</a>
        </li>

        <li>
            <a th:href="@{${'/users'}(
               page=${usersPage.getNumber()},
               size=${usersPage.getSize()},
               username=${userSearchRequest.username},
               fromAge=${userSearchRequest.fromAge},
               toAge=${userSearchRequest.toAge},
               locations=${userSearchRequest.locations},
               technologyStack=${userSearchRequest.technologyStack}
               )}"
               th:text="${usersPage.getNumber() + 1}"
            >Current</a>
        </li>

        <li>
            <a th:class="${usersPage.getNumber() + 1 < usersPage.getTotalPages() ? '' : 'disabled'}"
               th:href="@{${'/users'}(
               page=${usersPage.getNumber() + 1},
               size=${usersPage.getSize()},
               username=${userSearchRequest.username},
               fromAge=${userSearchRequest.fromAge},
               toAge=${userSearchRequest.toAge},
               locations=${userSearchRequest.locations},
               technologyStack=${userSearchRequest.technologyStack}
               )}"
               th:text="${usersPage.getNumber() + 1 < usersPage.getTotalPages() ? usersPage.getNumber() + 2 : '.'}"
            >Current + 1</a>
        </li>

        <li>
            <a th:class="${usersPage.getNumber() + 2 < usersPage.getTotalPages() ? '' : 'disabled'}"
               th:href="@{${'/users'}(
               page=${usersPage.getNumber() + 2},
               size=${usersPage.getSize()},
               username=${userSearchRequest.username},
               fromAge=${userSearchRequest.fromAge},
               toAge=${userSearchRequest.toAge},
               locations=${userSearchRequest.locations},
               technologyStack=${userSearchRequest.technologyStack}
               )}"
               th:text="${usersPage.getNumber() + 2 < usersPage.getTotalPages() ? usersPage.getNumber() + 3 : '.'}"
            >Current + 2</a>
        </li>

        <li>
            <a th:class="${usersPage.isLast() ? 'disabled' : ''}"
               th:href="@{${'/users'}(
               page=${usersPage.getNumber() + 1},
               size=${usersPage.getSize()},
               username=${userSearchRequest.username},
               fromAge=${userSearchRequest.fromAge},
               toAge=${userSearchRequest.toAge},
               locations=${userSearchRequest.locations},
               technologyStack=${userSearchRequest.technologyStack}
               )}"
               th:text="#{templates.common.pagination.next}"
            >Next</a>
        </li>

        <li>
            <a th:href="@{${'/users'}(
               page=${usersPage.getTotalPages() - 1},
               size=${usersPage.getSize()},
               username=${userSearchRequest.username},
               fromAge=${userSearchRequest.fromAge},
               toAge=${userSearchRequest.toAge},
               locations=${userSearchRequest.locations},
               technologyStack=${userSearchRequest.technologyStack}
               )}"
               th:text="#{templates.common.pagination.last}"
            >Last</a>
        </li>
    </ul>
</div>
<script>
    function addInput(containerId, templateId) {
        const container = document.getElementById(containerId);
        const template = document.getElementById(templateId);

        const clone = template.content.cloneNode(true);
        container.appendChild(clone);
    }

    function removeInput(button) {
        const inputGroup = button.closest('.dynamic-input-group');
        inputGroup.remove();
    }

    document.addEventListener("DOMContentLoaded", () => {
        if (document.querySelectorAll('#locations-container .dynamic-input-group').length === 0) {
            addInput('locations-container', 'location-template');
        }
        if (document.querySelectorAll('#tech-container .dynamic-input-group').length === 0) {
            addInput('tech-container', 'tech-template');
        }
    });
</script>
</body>
</html>
